<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ config.web.title }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta http-equiv="refresh" content="60">
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; }
    .soc-ring { transition: stroke-dashoffset 0.5s ease; }
  </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">

  <!-- Header -->
  <header class="bg-gray-900 border-b border-gray-800 px-6 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <span class="text-2xl">üèî</span>
      <h1 class="text-xl font-bold text-white tracking-tight">Safety Monitor</h1>
    </div>
    <div class="flex items-center gap-4 text-sm text-gray-400">
      {% set total_alerts = alerts|length %}
      {% if total_alerts > 0 %}
        <span class="bg-red-600 text-white px-3 py-1 rounded-full font-semibold">
          ‚ö† {{ total_alerts }} alert{{ 's' if total_alerts != 1 }}
        </span>
      {% else %}
        <span class="bg-green-900 text-green-300 px-3 py-1 rounded-full font-semibold">‚úì All clear</span>
      {% endif %}
      <span id="clock" class="font-mono tabular-nums"></span>
      <span class="text-gray-600">auto-refresh 60s</span>
      <button onclick="toggleSettings()" id="settings-btn"
        class="text-gray-400 hover:text-white px-2 py-1 rounded-lg hover:bg-gray-800 transition-colors text-base"
        title="Alert threshold settings">‚öô</button>
    </div>
  </header>

  <main class="p-6 max-w-7xl mx-auto">

    <!-- Property cards grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      {% for card in cards %}
      <div class="bg-gray-900 rounded-2xl border {% if card.alert_count > 0 %}border-red-700{% else %}border-gray-800{% endif %} overflow-hidden">

        <!-- Card header -->
        <div class="flex items-center justify-between px-5 py-4 border-b border-gray-800">
          <div>
            <h2 class="text-lg font-bold text-white">{{ card.name }}</h2>
            <p class="text-xs text-gray-500 font-mono">{{ card.id }}</p>
          </div>
          <div class="flex items-center gap-2">
            {% if card.alert_count > 0 %}
              <span class="bg-red-600 text-white text-xs px-2 py-0.5 rounded-full font-semibold">
                {{ card.alert_count }} alert{{ 's' if card.alert_count != 1 }}
              </span>
            {% endif %}
            {% if card.reading %}
              <span class="text-xs text-gray-500">{{ ago(card.reading.get('collected_at')) }}</span>
              <span class="w-2 h-2 rounded-full bg-green-400"></span>
            {% else %}
              <span class="text-xs text-gray-500">no data</span>
              <span class="w-2 h-2 rounded-full bg-gray-600"></span>
            {% endif %}
          </div>
        </div>

        <div class="p-5 space-y-5">

          <!-- Solar section (fm only ‚Äî has EG4/Victron) -->
          {% if card.reading.get('soc') is not none %}
          <div>
            <p class="text-xs uppercase tracking-wider text-gray-500 mb-3 font-semibold">Solar / Battery</p>
            <div class="flex items-center gap-6">

              <!-- SOC gauge -->
              <div class="relative flex-shrink-0">
                {% set soc = card.reading.get('soc', 0) %}
                {% set r = 36 %}
                {% set circ = (2 * 3.14159 * r)|round(1) %}
                {% set offset = (circ * (1 - soc/100))|round(1) %}
                {% set gauge_color = 'stroke-red-500' if soc < 10 else ('stroke-orange-500' if soc < 20 else ('stroke-yellow-400' if soc < 40 else 'stroke-green-500')) %}
                <svg width="90" height="90" viewBox="0 0 90 90">
                  <circle cx="45" cy="45" r="{{ r }}" fill="none" stroke="#374151" stroke-width="8"/>
                  <circle cx="45" cy="45" r="{{ r }}" fill="none"
                    class="{{ gauge_color }} soc-ring"
                    stroke-width="8"
                    stroke-dasharray="{{ circ }}"
                    stroke-dashoffset="{{ offset }}"
                    stroke-linecap="round"
                    transform="rotate(-90 45 45)"/>
                  <text x="45" y="49" text-anchor="middle"
                    class="fill-white" font-size="16" font-weight="bold">{{ soc|int }}%</text>
                </svg>
              </div>

              <!-- Readings -->
              <div class="grid grid-cols-2 gap-x-6 gap-y-2 flex-1">
                {% if card.reading.get('voltage') %}
                <div>
                  <p class="text-xs text-gray-500">Voltage</p>
                  <p class="text-sm font-semibold">{{ fmt_voltage(card.reading.get('voltage')) }}</p>
                </div>
                {% endif %}

                <!-- Battery charging power (Victron SmartShunt) -->
                {% set chg = card.reading.get('battery_charging_power') %}
                {% if chg is not none %}
                <div>
                  <p class="text-xs text-gray-500">Battery</p>
                  {% if chg > 50 %}
                    <p class="text-sm font-semibold text-green-400">‚¨Ü {{ fmt_power(chg) }}</p>
                  {% elif chg < -50 %}
                    <p class="text-sm font-semibold text-yellow-400">‚¨á {{ fmt_power(chg|abs) }}</p>
                  {% else %}
                    <p class="text-sm font-semibold text-gray-400">‚âà 0 W</p>
                  {% endif %}
                </div>
                {% elif card.reading.get('pv_power') %}
                <div>
                  <p class="text-xs text-gray-500">PV Power</p>
                  <p class="text-sm font-semibold">{{ fmt_power(card.reading.get('pv_power')) }}</p>
                </div>
                {% endif %}

                {% if card.reading.get('temperature') %}
                <div>
                  <p class="text-xs text-gray-500">Inverter Temp</p>
                  <p class="text-sm font-semibold">{{ card.reading.get('temperature')|round(0)|int }}¬∞C</p>
                </div>
                {% endif %}
              </div>
            </div>

            <!-- 3-MPPT generation breakdown (Forgetmenot only) -->
            {% set pv_eg4 = card.reading.get('pv_eg4') %}
            {% set pv_v1  = card.reading.get('pv_victron_1') %}
            {% set pv_v2  = card.reading.get('pv_victron_2') %}
            {% if pv_eg4 is not none or pv_v1 is not none or pv_v2 is not none %}
            <div class="mt-3 bg-gray-800 rounded-xl px-4 py-3 space-y-1.5">
              <p class="text-xs uppercase tracking-wider text-gray-500 font-semibold mb-2">Generation</p>
              {% if pv_eg4 is not none %}
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">EG4 MPPT</span>
                <span class="font-semibold text-yellow-300">{{ fmt_power(pv_eg4) }}</span>
              </div>
              {% endif %}
              {% if pv_v1 is not none %}
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">Victron #1 (288)</span>
                <span class="font-semibold text-yellow-300">{{ fmt_power(pv_v1) }}</span>
              </div>
              {% endif %}
              {% if pv_v2 is not none %}
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">Victron #2 (289)</span>
                <span class="font-semibold text-yellow-300">{{ fmt_power(pv_v2) }}</span>
              </div>
              {% endif %}
              {% set total_pv = card.reading.get('pv_total_power') or card.reading.get('pv_power') %}
              {% if total_pv %}
              <div class="flex justify-between text-sm border-t border-gray-700 pt-1.5 mt-1">
                <span class="text-gray-300 font-semibold">Total PV</span>
                <span class="font-bold text-white">{{ fmt_power(total_pv) }}</span>
              </div>
              {% endif %}
              {% set load = card.reading.get('load_power') %}
              {% if load is not none %}
              <div class="flex justify-between text-sm border-t border-gray-700 pt-1.5 mt-1">
                <span class="text-gray-400">House Load</span>
                <span class="font-semibold text-blue-300">{{ fmt_power(load) }}</span>
              </div>
              {% endif %}
            </div>
            {% endif %}

          </div>
          {% endif %}

          <!-- Tesla section (hc only) -->
          {% if card.reading.get('tesla_soc') is not none %}
          <div>
            <p class="text-xs uppercase tracking-wider text-gray-500 mb-3 font-semibold">Tesla</p>
            <div class="flex items-center gap-4">
              <span class="text-3xl">üöó</span>
              <div class="grid grid-cols-2 gap-x-6 gap-y-1">
                <div>
                  <p class="text-xs text-gray-500">Battery</p>
                  <p class="text-sm font-semibold">{{ fmt_pct(card.reading.get('tesla_soc')) }}</p>
                </div>
                {% if card.reading.get('tesla_charging') %}
                <div>
                  <p class="text-xs text-gray-500">Charging</p>
                  <p class="text-sm font-semibold text-green-400">
                    ‚ö° {{ "%.1f kW"|format(card.reading.get('tesla_power_kw', 0)) }}
                  </p>
                </div>
                {% else %}
                <div>
                  <p class="text-xs text-gray-500">Status</p>
                  <p class="text-sm font-semibold text-gray-400">Idle</p>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          {% endif %}

          <!-- Temperature -->
          {% if card.primary_temp is not none %}
          <div>
            <p class="text-xs uppercase tracking-wider text-gray-500 mb-2 font-semibold">Temperature</p>
            <div class="flex items-center gap-3">
              {% set ts = card.temp_status %}
              <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-semibold
                {% if ts == 'critical' %}bg-red-900 text-red-300
                {% elif ts == 'warning' %}bg-yellow-900 text-yellow-300
                {% else %}bg-green-900 text-green-300{% endif %}">
                {% if ts == 'critical' %}ü•∂{% elif ts == 'warning' %}üå°{% else %}üå°{% endif %}
                {{ fmt_temp(card.primary_temp) }}
              </span>
              {% if ts == 'critical' %}<span class="text-xs text-red-400 font-semibold">FREEZING RISK</span>
              {% elif ts == 'warning' %}<span class="text-xs text-yellow-400">Near threshold</span>{% endif %}
            </div>
          </div>
          {% endif %}

          <!-- Device batteries -->
          {% if card.devices %}
          <div>
            <p class="text-xs uppercase tracking-wider text-gray-500 mb-2 font-semibold">
              Device Batteries ({{ card.devices|length }})
            </p>
            <div class="space-y-1.5 max-h-40 overflow-y-auto pr-1">
              {% for dev in card.devices %}
              {% set bs = battery_status(dev.battery_pct) %}
              <div class="flex items-center justify-between text-sm">
                <span class="text-gray-300 truncate max-w-[65%]">{{ dev.friendly_name }}</span>
                <span class="font-semibold flex-shrink-0
                  {% if bs == 'critical' %}text-red-400
                  {% elif bs == 'low' %}text-yellow-400
                  {% else %}text-green-400{% endif %}">
                  {{ fmt_pct(dev.battery_pct) }}
                </span>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- No data state -->
          {% if not card.reading %}
          <div class="flex flex-col items-center py-6 text-gray-600">
            <span class="text-4xl mb-2">üì°</span>
            <p class="text-sm">No data collected yet</p>
            <p class="text-xs">Waiting for first collection cycle...</p>
          </div>
          {% endif %}

        </div><!-- /card body -->
      </div><!-- /card -->
      {% endfor %}
    </div><!-- /grid -->

    <!-- Recent alerts -->
    {% if alerts %}
    <div class="bg-gray-900 rounded-2xl border border-gray-800 overflow-hidden">
      <div class="px-5 py-4 border-b border-gray-800">
        <h2 class="text-base font-bold text-white">Recent Alerts (last 48h)</h2>
      </div>
      <div class="divide-y divide-gray-800">
        {% for alert in alerts %}
        <div class="px-5 py-3 flex items-start gap-3">
          <span class="flex-shrink-0 mt-0.5
            {% if alert.severity == 'critical' %}text-red-400
            {% else %}text-yellow-400{% endif %}">
            {% if alert.alert_type == 'temperature' %}üå°
            {% elif alert.alert_type == 'battery' %}üîã
            {% elif alert.alert_type == 'offline' %}üì°
            {% else %}‚ö†{% endif %}
          </span>
          <div class="flex-1 min-w-0">
            <p class="text-sm text-gray-200">{{ alert.message }}</p>
            <p class="text-xs text-gray-500 mt-0.5">
              {{ ago(alert.triggered_at) }}
              {% if alert.pushover_sent %} ¬∑ pushed{% endif %}
            </p>
          </div>
          <span class="text-xs font-mono text-gray-600 flex-shrink-0">{{ alert.property_id }}</span>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Settings panel (hidden by default, toggled via ‚öô button) -->
    <div id="settings-panel" class="hidden mt-4">
      <div class="bg-gray-900 rounded-2xl border border-gray-700 overflow-hidden">
        <div class="px-5 py-4 border-b border-gray-800 flex items-center justify-between">
          <h2 class="text-base font-bold text-white">‚öô Alert Thresholds</h2>
          <span class="text-xs text-gray-500">Changes take effect on next collection cycle</span>
        </div>
        <div class="p-5 space-y-5">
          {% for card in cards %}
          <div class="bg-gray-800 rounded-xl p-4">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-semibold text-white">{{ card.name }}</h3>
              <button onclick="saveThresholds('{{ card.id }}')"
                class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg font-semibold transition-colors">
                Save
              </button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-3">
              <label class="block">
                <span class="text-xs text-gray-400 block mb-1">Indoor Warning (¬∞F)</span>
                <input type="number" step="1"
                  id="{{ card.id }}_indoor_temp_warning"
                  value="{{ card.alerts_cfg.indoor_temp_warning|int }}"
                  class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:border-blue-500">
              </label>
              <label class="block">
                <span class="text-xs text-gray-400 block mb-1">Indoor Critical (¬∞F)</span>
                <input type="number" step="1"
                  id="{{ card.id }}_indoor_temp_critical"
                  value="{{ card.alerts_cfg.indoor_temp_critical|int }}"
                  class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:border-blue-500">
              </label>
              <label class="block">
                <span class="text-xs text-gray-400 block mb-1">Outdoor Warning (¬∞F)</span>
                <input type="number" step="1"
                  id="{{ card.id }}_outdoor_temp_warning"
                  value="{{ card.alerts_cfg.outdoor_temp_warning|int }}"
                  class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:border-blue-500">
              </label>
              <label class="block">
                <span class="text-xs text-gray-400 block mb-1">Outdoor Critical (¬∞F)</span>
                <input type="number" step="1"
                  id="{{ card.id }}_outdoor_temp_critical"
                  value="{{ card.alerts_cfg.outdoor_temp_critical|int }}"
                  class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:border-blue-500">
              </label>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <label class="block">
                <span class="text-xs text-gray-400 block mb-1">Outdoor Sensors (comma-separated)</span>
                <input type="text"
                  id="{{ card.id }}_outdoor_sensors"
                  value="{{ card.alerts_cfg.outdoor_sensors }}"
                  placeholder="e.g. Deck temperature, Coop sensor"
                  class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:border-blue-500">
              </label>
              <label class="block">
                <span class="text-xs text-gray-400 block mb-1">Excluded Sensors (comma-separated)</span>
                <input type="text"
                  id="{{ card.id }}_exclude_sensors"
                  value="{{ card.alerts_cfg.exclude_sensors }}"
                  placeholder="e.g. rpoffice"
                  class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:border-blue-500">
              </label>
            </div>
            <div id="{{ card.id }}_status" class="mt-2 text-xs hidden"></div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

  </main>

  <!-- Footer -->
  <footer class="text-center py-6 text-gray-700 text-xs">
    Safety Monitor ¬∑ Tailscale-accessible ¬∑ data refreshes every 15 min ¬∑ page auto-refreshes every 60s
  </footer>

  <script>
    // Live clock
    function updateClock() {
      const now = new Date();
      document.getElementById('clock').textContent =
        now.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', second:'2-digit', timeZoneName:'short'});
    }
    updateClock();
    setInterval(updateClock, 1000);

    // Settings panel toggle
    function toggleSettings() {
      const panel = document.getElementById('settings-panel');
      const btn   = document.getElementById('settings-btn');
      const shown = !panel.classList.contains('hidden');
      panel.classList.toggle('hidden', shown);
      btn.classList.toggle('bg-gray-700', !shown);
      btn.classList.toggle('text-white',  !shown);
    }

    // Save thresholds for a property
    async function saveThresholds(pid) {
      const g = id => document.getElementById(`${pid}_${id}`)?.value?.trim() ?? '';
      const payload = {
        indoor_temp_warning:  parseFloat(g('indoor_temp_warning')),
        indoor_temp_critical: parseFloat(g('indoor_temp_critical')),
        outdoor_temp_warning: parseFloat(g('outdoor_temp_warning')),
        outdoor_temp_critical:parseFloat(g('outdoor_temp_critical')),
        outdoor_sensors:      g('outdoor_sensors'),
        exclude_sensors:      g('exclude_sensors'),
      };
      const statusEl = document.getElementById(`${pid}_status`);
      statusEl.classList.remove('hidden', 'text-green-400', 'text-red-400');
      statusEl.textContent = 'Saving‚Ä¶';
      statusEl.classList.add('text-gray-400');
      try {
        const resp = await fetch(`/api/config/thresholds/${pid}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload),
        });
        if (resp.ok) {
          statusEl.textContent = '‚úì Saved';
          statusEl.classList.replace('text-gray-400', 'text-green-400');
        } else {
          const err = await resp.json();
          statusEl.textContent = `‚úó Error: ${err.error || resp.status}`;
          statusEl.classList.replace('text-gray-400', 'text-red-400');
        }
      } catch (e) {
        statusEl.textContent = `‚úó ${e.message}`;
        statusEl.classList.replace('text-gray-400', 'text-red-400');
      }
      setTimeout(() => statusEl.classList.add('hidden'), 4000);
    }
  </script>

</body>
</html>
