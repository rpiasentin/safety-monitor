<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ config.web.title }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta http-equiv="refresh" content="60">
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; }
    .soc-ring { transition: stroke-dashoffset 0.5s ease; }
  </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">

  <!-- Header -->
  <header class="bg-gray-900 border-b border-gray-800 px-6 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <span class="text-2xl">ğŸ”</span>
      <h1 class="text-xl font-bold text-white tracking-tight">Safety Monitor</h1>
    </div>
    <div class="flex items-center gap-4 text-sm text-gray-400">
      {% set total_alerts = alerts|length %}
      {% if total_alerts > 0 %}
        <span class="bg-red-600 text-white px-3 py-1 rounded-full font-semibold">
          âš  {{ total_alerts }} alert{{ 's' if total_alerts != 1 }}
        </span>
      {% else %}
        <span class="bg-green-900 text-green-300 px-3 py-1 rounded-full font-semibold">âœ“ All clear</span>
      {% endif %}
      <span id="clock" class="font-mono tabular-nums"></span>
      <span class="text-gray-600">auto-refresh 60s</span>
      <button onclick="toggleSettings()" id="settings-btn"
        class="text-gray-400 hover:text-white px-3 py-1.5 rounded-lg hover:bg-gray-800 transition-colors text-sm font-medium border border-gray-700 hover:border-gray-500"
        title="Alert rule settings">âš™ Alert Rules</button>
    </div>
  </header>

  <main class="p-6 max-w-7xl mx-auto">

    <!-- Settings panel (hidden by default, toggled via Alert Rules button in header) -->
    <div id="settings-panel" class="hidden mb-8">
      <div class="bg-gray-900 rounded-2xl border border-blue-800 overflow-hidden">
        <div class="px-5 py-4 border-b border-gray-800 flex items-center justify-between">
          <h2 class="text-base font-bold text-white">âš™ Alert Rules â€” per property</h2>
          <button onclick="toggleSettings()" class="text-gray-500 hover:text-white text-sm">âœ• Close</button>
        </div>
        <div class="px-5 py-3 border-b border-gray-800 text-xs text-gray-400">
          This panel controls the live rules used by dashboard badges and Pushover alerts:
          temperature, battery, offline, and water leak handling.
        </div>
        <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4">
          {% for card in cards %}
          <div class="bg-gray-800 rounded-xl p-4">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-semibold text-white">{{ card.name }}</h3>
              <button onclick="saveThresholds('{{ card.id }}')"
                class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg font-semibold transition-colors">
                Save
              </button>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-3">
              <label class="block">
                <span class="text-xs text-gray-400 block mb-1">ğŸ  Indoor Warning (Â°F)</span>
                <input type="number" step="1"
                  id="{{ card.id }}_indoor_temp_warning"
                  value="{{ card.alerts_cfg.indoor_temp_warning|int }}"
                  class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:border-blue-500">
              </label>
              <label class="block">
                <span class="text-xs text-gray-400 block mb-1">ğŸ¥¶ Indoor Critical (Â°F)</span>
                <input type="number" step="1"
                  id="{{ card.id }}_indoor_temp_critical"
                  value="{{ card.alerts_cfg.indoor_temp_critical|int }}"
                  class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:border-blue-500">
              </label>
              <label class="block">
                <span class="text-xs text-gray-400 block mb-1">ğŸŒ² Outdoor Warning (Â°F)</span>
                <input type="number" step="1"
                  id="{{ card.id }}_outdoor_temp_warning"
                  value="{{ card.alerts_cfg.outdoor_temp_warning|int }}"
                  class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:border-blue-500">
              </label>
              <label class="block">
                <span class="text-xs text-gray-400 block mb-1">â„ï¸ Outdoor Critical (Â°F)</span>
                <input type="number" step="1"
                  id="{{ card.id }}_outdoor_temp_critical"
                  value="{{ card.alerts_cfg.outdoor_temp_critical|int }}"
                  class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:border-blue-500">
              </label>
            </div>
            <!-- Primary display sensor -->
            <div class="mb-3">
              <span class="text-xs text-gray-400 block mb-1">ğŸŒ¡ Primary Display Sensor</span>
              <select id="{{ card.id }}_primary_sensor"
                data-current="{{ card.alerts_cfg.primary_temp_sensor }}"
                class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:border-blue-500">
                <option value="{{ card.alerts_cfg.primary_temp_sensor }}">
                  {{ card.alerts_cfg.primary_temp_sensor or 'â€” open panel to load sensors â€”' }}
                </option>
              </select>
            </div>

            <!-- Sensor classification table -->
            <div class="mt-1">
              <div class="flex items-center justify-between mb-1">
                <span class="text-xs text-gray-400">Sensor Classification</span>
                <span class="text-xs text-gray-600">ğŸ  Indoor Â· ğŸŒ² Outdoor Â· ğŸš« Skip</span>
              </div>
              <div id="{{ card.id }}_sensor_list"
                data-outdoor='{{ card.alerts_cfg.outdoor_sensors | tojson }}'
                data-exclude='{{ card.alerts_cfg.exclude_sensors | tojson }}'
                class="space-y-0.5 max-h-52 overflow-y-auto rounded-lg bg-gray-700 border border-gray-600 p-2">
                <p class="text-xs text-gray-500 italic py-2 text-center">Click âš™ Alert Rules to load sensorsâ€¦</p>
              </div>
            </div>
            <div class="mt-3 pt-3 border-t border-gray-700 space-y-3">
              <div>
                <p class="text-xs text-gray-400 mb-2">ğŸ”‹ Battery Alerts</p>
                <div class="grid grid-cols-2 gap-3">
                  <label class="block">
                    <span class="text-xs text-gray-500 block mb-1">Warning %</span>
                    <input type="number" step="1"
                      id="{{ card.id }}_battery_low_threshold_percent"
                      value="{{ card.alerts_cfg.battery_low_threshold_percent|int }}"
                      class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:border-blue-500">
                  </label>
                  <label class="block">
                    <span class="text-xs text-gray-500 block mb-1">Critical %</span>
                    <input type="number" step="1"
                      id="{{ card.id }}_battery_critical_threshold_percent"
                      value="{{ card.alerts_cfg.battery_critical_threshold_percent|int }}"
                      class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:border-blue-500">
                  </label>
                  <label class="block">
                    <span class="text-xs text-gray-500 block mb-1">Cooldown (min)</span>
                    <input type="number" step="1"
                      id="{{ card.id }}_battery_cooldown_minutes"
                      value="{{ card.alerts_cfg.battery_cooldown_minutes|int }}"
                      class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:border-blue-500">
                  </label>
                  <label class="flex items-end pb-1 gap-2">
                    <input type="checkbox"
                      id="{{ card.id }}_battery_pushover_enabled"
                      {% if card.alerts_cfg.battery_pushover_enabled %}checked{% endif %}
                      class="accent-blue-500">
                    <span class="text-xs text-gray-400">Send Pushover</span>
                  </label>
                </div>
                <label class="block mt-2">
                  <span class="text-xs text-gray-500 block mb-1">Exclude devices (comma-separated)</span>
                  <input type="text"
                    id="{{ card.id }}_battery_exclude_devices"
                    value="{{ card.alerts_cfg.battery_exclude_devices|join(', ') }}"
                    class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:border-blue-500">
                </label>
              </div>

              <div class="pt-3 border-t border-gray-700">
                <p class="text-xs text-gray-400 mb-2">ğŸ“¡ Offline Alerts</p>
                <div class="grid grid-cols-2 gap-3">
                  <label class="block">
                    <span class="text-xs text-gray-500 block mb-1">Timeout (min)</span>
                    <input type="number" step="1"
                      id="{{ card.id }}_offline_timeout_minutes"
                      value="{{ card.alerts_cfg.offline_timeout_minutes|int }}"
                      class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:border-blue-500">
                  </label>
                  <label class="block">
                    <span class="text-xs text-gray-500 block mb-1">Cooldown (min)</span>
                    <input type="number" step="1"
                      id="{{ card.id }}_offline_cooldown_minutes"
                      value="{{ card.alerts_cfg.offline_cooldown_minutes|int }}"
                      class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:border-blue-500">
                  </label>
                  <label class="flex items-end pb-1 gap-2 col-span-2">
                    <input type="checkbox"
                      id="{{ card.id }}_offline_pushover_enabled"
                      {% if card.alerts_cfg.offline_pushover_enabled %}checked{% endif %}
                      class="accent-blue-500">
                    <span class="text-xs text-gray-400">Send Pushover</span>
                  </label>
                </div>
              </div>

              <div class="pt-3 border-t border-gray-700">
                <p class="text-xs text-gray-400 mb-2">ğŸ’§ Water Alerts</p>
                <div class="grid grid-cols-1 gap-3">
                  <label class="flex items-center gap-2">
                    <input type="checkbox"
                      id="{{ card.id }}_water_pushover_enabled"
                      {% if card.alerts_cfg.water_pushover_enabled %}checked{% endif %}
                      class="accent-blue-500">
                    <span class="text-xs text-gray-400">Send Pushover</span>
                  </label>
                  <label class="block">
                    <span class="text-xs text-gray-500 block mb-1">Exclude water sensors (comma-separated)</span>
                    <input type="text"
                      id="{{ card.id }}_water_exclude_sensors"
                      value="{{ card.alerts_cfg.water_exclude_sensors|join(', ') }}"
                      class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:border-blue-500">
                  </label>
                </div>
              </div>
            </div>
            <div id="{{ card.id }}_status" class="mt-2 text-xs hidden"></div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Property cards grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      {% for card in cards %}
      <div class="bg-gray-900 rounded-2xl border {% if card.alert_count > 0 %}border-red-700{% else %}border-gray-800{% endif %} overflow-hidden">

        <!-- Card header -->
        <div class="flex items-center justify-between px-5 py-4 border-b border-gray-800">
          <div>
            <h2 class="text-lg font-bold text-white">{{ card.name }}</h2>
            <p class="text-xs text-gray-500 font-mono">{{ card.id }}</p>
          </div>
          <div class="flex items-center gap-2">
            {% if card.alert_count > 0 %}
              <span class="bg-red-600 text-white text-xs px-2 py-0.5 rounded-full font-semibold">
                {{ card.alert_count }} alert{{ 's' if card.alert_count != 1 }}
              </span>
            {% endif %}
            {% if card.reading %}
              <span class="text-xs text-gray-500">{{ ago(card.reading.get('collected_at')) }}</span>
              <span class="w-2 h-2 rounded-full bg-green-400"></span>
            {% else %}
              <span class="text-xs text-gray-500">no data</span>
              <span class="w-2 h-2 rounded-full bg-gray-600"></span>
            {% endif %}
          </div>
        </div>

        <div class="p-5 space-y-5">

          <!-- Solar section (fm only â€” has EG4/Victron) -->
          {% if card.reading.get('soc') is not none %}
          <div>
            <p class="text-xs uppercase tracking-wider text-gray-500 mb-3 font-semibold">Solar / Battery</p>
            <div class="flex items-center gap-6">

              <!-- SOC gauge -->
              <div class="relative flex-shrink-0">
                {% set soc = card.reading.get('soc', 0) %}
                {% set r = 36 %}
                {% set circ = (2 * 3.14159 * r)|round(1) %}
                {% set offset = (circ * (1 - soc/100))|round(1) %}
                {% set gauge_color = 'stroke-red-500' if soc < 10 else ('stroke-orange-500' if soc < 20 else ('stroke-yellow-400' if soc < 40 else 'stroke-green-500')) %}
                <svg width="90" height="90" viewBox="0 0 90 90">
                  <circle cx="45" cy="45" r="{{ r }}" fill="none" stroke="#374151" stroke-width="8"/>
                  <circle cx="45" cy="45" r="{{ r }}" fill="none"
                    class="{{ gauge_color }} soc-ring"
                    stroke-width="8"
                    stroke-dasharray="{{ circ }}"
                    stroke-dashoffset="{{ offset }}"
                    stroke-linecap="round"
                    transform="rotate(-90 45 45)"/>
                  <text x="45" y="49" text-anchor="middle"
                    class="fill-white" font-size="16" font-weight="bold">{{ soc|int }}%</text>
                </svg>
              </div>

              <!-- Readings -->
              <div class="grid grid-cols-2 gap-x-6 gap-y-2 flex-1">
                {% if card.reading.get('voltage') %}
                <div>
                  <p class="text-xs text-gray-500">Voltage</p>
                  <p class="text-sm font-semibold">{{ fmt_voltage(card.reading.get('voltage')) }}</p>
                </div>
                {% endif %}

                <!-- Battery charging power (Victron SmartShunt) -->
                {% set chg = card.reading.get('battery_charging_power') %}
                {% if chg is not none %}
                <div>
                  <p class="text-xs text-gray-500">Battery</p>
                  {% if chg > 50 %}
                    <p class="text-sm font-semibold text-green-400">â¬† {{ fmt_power(chg) }}</p>
                  {% elif chg < -50 %}
                    <p class="text-sm font-semibold text-yellow-400">â¬‡ {{ fmt_power(chg|abs) }}</p>
                  {% else %}
                    <p class="text-sm font-semibold text-gray-400">â‰ˆ 0 W</p>
                  {% endif %}
                </div>
                {% elif card.reading.get('pv_power') %}
                <div>
                  <p class="text-xs text-gray-500">PV Power</p>
                  <p class="text-sm font-semibold">{{ fmt_power(card.reading.get('pv_power')) }}</p>
                </div>
                {% endif %}

                {% if card.reading.get('temperature') %}
                <div>
                  <p class="text-xs text-gray-500">Inverter Temp</p>
                  <p class="text-sm font-semibold">{{ card.reading.get('temperature')|round(0)|int }}Â°C</p>
                </div>
                {% endif %}
              </div>
            </div>

            <!-- Generation breakdown (EG4/Victron for FM; Tesla energy for HC) -->
            {% set pv_eg4   = card.reading.get('pv_eg4') %}
            {% set pv_eg4_1 = card.reading.get('pv_eg4_1') %}
            {% set pv_eg4_2 = card.reading.get('pv_eg4_2') %}
            {% set pv_v1    = card.reading.get('pv_victron_1') %}
            {% set pv_v2    = card.reading.get('pv_victron_2') %}
            {% set total_pv = card.reading.get('pv_total_power') or card.reading.get('pv_power') %}
            {% set load     = card.reading.get('load_power') %}
            {% if pv_eg4 is not none or pv_v1 is not none or pv_v2 is not none or total_pv or load is not none %}
            <div class="mt-3 bg-gray-800 rounded-xl px-4 py-3 space-y-1.5">
              <p class="text-xs uppercase tracking-wider text-gray-500 font-semibold mb-2">Generation</p>
              {% if pv_eg4_1 is not none %}
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">EG4 String 1</span>
                <span class="font-semibold text-yellow-300">{{ fmt_power(pv_eg4_1) }}</span>
              </div>
              {% endif %}
              {% if pv_eg4_2 is not none %}
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">EG4 String 2</span>
                <span class="font-semibold text-yellow-300">{{ fmt_power(pv_eg4_2) }}</span>
              </div>
              {% endif %}
              {% if pv_eg4 is not none and pv_eg4_1 is none %}
              {# Fallback: no per-string data, just show EG4 total #}
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">EG4 MPPT</span>
                <span class="font-semibold text-yellow-300">{{ fmt_power(pv_eg4) }}</span>
              </div>
              {% endif %}
              {% if pv_v1 is not none %}
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">Victron #1 (288)</span>
                <span class="font-semibold text-yellow-300">{{ fmt_power(pv_v1) }}</span>
              </div>
              {% endif %}
              {% if pv_v2 is not none %}
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">Victron #2 (289)</span>
                <span class="font-semibold text-yellow-300">{{ fmt_power(pv_v2) }}</span>
              </div>
              {% endif %}
              {% if total_pv %}
              <div class="flex justify-between text-sm border-t border-gray-700 pt-1.5 mt-1">
                <span class="text-gray-300 font-semibold">Total PV</span>
                <span class="font-bold text-white">{{ fmt_power(total_pv) }}</span>
              </div>
              {% endif %}
              {% if load is not none %}
              <div class="flex justify-between text-sm border-t border-gray-700 pt-1.5 mt-1">
                <span class="text-gray-400">House Load</span>
                <span class="font-semibold text-blue-300">{{ fmt_power(load) }}</span>
              </div>
              {% endif %}
              {% set grid_pwr = card.reading.get('grid_power') %}
              {% if grid_pwr is not none %}
              {% set grid_color = 'text-green-400' if grid_pwr < 0 else 'text-orange-300' %}
              {% set grid_label = 'Grid Export' if grid_pwr < 0 else 'Grid Import' %}
              <div class="flex justify-between text-sm border-t border-gray-700 pt-1.5 mt-1">
                <span class="text-gray-400">{{ grid_label }}</span>
                <span class="font-semibold {{ grid_color }}">{{ fmt_power(grid_pwr|abs) }}</span>
              </div>
              {% endif %}
            </div>
            {% endif %}

          </div>
          {% endif %}

          <!-- Tesla section (vehicle or Powerwall depending on integration type) -->
          {% if card.reading.get('tesla_soc') is not none and card.reading.get('grid_online') is none %}
          {# Vehicle Tesla â€” shows car SOC and charging status #}
          <div>
            <p class="text-xs uppercase tracking-wider text-gray-500 mb-3 font-semibold">Tesla</p>
            <div class="flex items-center gap-4">
              <span class="text-3xl">ğŸš—</span>
              <div class="grid grid-cols-2 gap-x-6 gap-y-1">
                <div>
                  <p class="text-xs text-gray-500">Battery</p>
                  <p class="text-sm font-semibold">{{ fmt_pct(card.reading.get('tesla_soc')) }}</p>
                </div>
                {% if card.reading.get('tesla_charging') %}
                <div>
                  <p class="text-xs text-gray-500">Charging</p>
                  <p class="text-sm font-semibold text-green-400">
                    âš¡ {{ "%.1f kW"|format(card.reading.get('tesla_power_kw', 0)) }}
                  </p>
                </div>
                {% else %}
                <div>
                  <p class="text-xs text-gray-500">Status</p>
                  <p class="text-sm font-semibold text-gray-400">Idle</p>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          {% endif %}

          {% if card.reading.get('grid_online') is not none %}
          {# Powerwall / Tesla Energy â€” shows backup reserve and grid status #}
          <div>
            <p class="text-xs uppercase tracking-wider text-gray-500 mb-3 font-semibold">Powerwall</p>
            <div class="flex items-center gap-4">
              <span class="text-3xl">ğŸ”‹</span>
              <div class="grid grid-cols-2 gap-x-6 gap-y-1">
                <div>
                  <p class="text-xs text-gray-500">Charge</p>
                  <p class="text-sm font-semibold">{{ fmt_pct(card.reading.get('soc')) }}</p>
                </div>
                <div>
                  <p class="text-xs text-gray-500">Grid</p>
                  {% if card.reading.get('grid_online') %}
                  <p class="text-sm font-semibold text-green-400">Online</p>
                  {% else %}
                  <p class="text-sm font-semibold text-red-400">âš  Offline</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- Temperature -->
          {% if card.primary_temp is not none %}
          <div>
            <p class="text-xs uppercase tracking-wider text-gray-500 mb-2 font-semibold">Temperature</p>
            <div class="flex items-center gap-3">
              {% set ts = card.temp_status %}
              <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-semibold
                {% if ts == 'critical' %}bg-red-900 text-red-300
                {% elif ts == 'warning' %}bg-yellow-900 text-yellow-300
                {% else %}bg-green-900 text-green-300{% endif %}">
                {% if ts == 'critical' %}ğŸ¥¶{% elif ts == 'warning' %}ğŸŒ¡{% else %}ğŸŒ¡{% endif %}
                {{ fmt_temp(card.primary_temp) }}
              </span>
              {% if ts == 'critical' %}<span class="text-xs text-red-400 font-semibold">FREEZING RISK</span>
              {% elif ts == 'warning' %}<span class="text-xs text-yellow-400">Near threshold</span>{% endif %}
            </div>
          </div>
          {% endif %}

          <!-- Device batteries -->
          {% if card.devices %}
          <div>
            <p class="text-xs uppercase tracking-wider text-gray-500 mb-2 font-semibold">
              Device Batteries ({{ card.devices|length }})
            </p>
            <div class="space-y-1.5 max-h-40 overflow-y-auto pr-1">
              {% for dev in card.devices %}
              {% set bs = battery_status(dev.battery_pct) %}
              <div class="flex items-center justify-between text-sm">
                <span class="text-gray-300 truncate max-w-[65%]">{{ dev.friendly_name }}</span>
                <span class="font-semibold flex-shrink-0
                  {% if bs == 'critical' %}text-red-400
                  {% elif bs == 'low' %}text-yellow-400
                  {% else %}text-green-400{% endif %}">
                  {{ fmt_pct(dev.battery_pct) }}
                </span>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Device activity link -->
          {% set has_hubitat = namespace(found=false) %}
          {% for c in config.properties %}
            {% if c.id == card.id %}
              {% for col in c.collectors %}
                {% if col.type == 'hubitat_cloud' %}{% set has_hubitat.found = true %}{% endif %}
              {% endfor %}
            {% endif %}
          {% endfor %}
          {% if has_hubitat.found %}
          <a href="/devices/{{ card.id }}"
             class="flex items-center justify-between text-xs text-gray-500 hover:text-blue-400 transition-colors mt-1 pt-2 border-t border-gray-800 group">
            <span>ğŸ“Ÿ Device activity</span>
            <span class="group-hover:translate-x-0.5 transition-transform">â†’</span>
          </a>
          {% endif %}

          <!-- No data state -->
          {% if not card.reading %}
          <div class="flex flex-col items-center py-6 text-gray-600">
            <span class="text-4xl mb-2">ğŸ“¡</span>
            <p class="text-sm">No data collected yet</p>
            <p class="text-xs">Waiting for first collection cycle...</p>
          </div>
          {% endif %}

        </div><!-- /card body -->
      </div><!-- /card -->
      {% endfor %}
    </div><!-- /grid -->

    <!-- Recent alerts -->
    {% if alerts %}
    <div class="bg-gray-900 rounded-2xl border border-gray-800 overflow-hidden">
      <div class="px-5 py-4 border-b border-gray-800">
        <h2 class="text-base font-bold text-white">Alerts (active leaks + recent)</h2>
      </div>
      <div class="divide-y divide-gray-800">
        {% for alert in alerts %}
        <div id="alert-row-{{ alert.id }}" class="px-5 py-3 flex items-start gap-3">
          <span class="flex-shrink-0 mt-0.5
            {% if alert.severity == 'critical' %}text-red-400
            {% else %}text-yellow-400{% endif %}">
            {% if alert.alert_type == 'temperature' %}ğŸŒ¡
            {% elif alert.alert_type == 'battery' %}ğŸ”‹
            {% elif alert.alert_type == 'offline' %}ğŸ“¡
            {% elif alert.alert_type == 'water' %}ğŸ’§
            {% else %}âš {% endif %}
          </span>
          <div class="flex-1 min-w-0">
            <p class="text-sm text-gray-200">{{ alert.message }}</p>
            <p class="text-xs text-gray-500 mt-0.5">
              {{ ago(alert.triggered_at) }}
              {% if alert.pushover_sent %} Â· pushed{% endif %}
              {% if alert.alert_type == 'water' and not alert.resolved_at %} Â· latched until cleared{% endif %}
            </p>
          </div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <span class="text-xs font-mono text-gray-600">{{ alert.property_id }}</span>
            {% if alert.alert_type == 'water' and not alert.resolved_at %}
            <button onclick="clearWaterAlert({{ alert.id }})"
                    class="text-xs px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-gray-200 border border-gray-600">
              Clear
            </button>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

  </main>

  <!-- Footer -->
  <footer class="text-center py-6 text-gray-700 text-xs">
    Safety Monitor Â· Tailscale-accessible Â· data refreshes every 15 min Â· page auto-refreshes every 60s
  </footer>

  <script>
    // Live clock
    function updateClock() {
      const now = new Date();
      document.getElementById('clock').textContent =
        now.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', second:'2-digit', timeZoneName:'short'});
    }
    updateClock();
    setInterval(updateClock, 1000);

    // Load sensor classification table for a property
    async function loadSensors(pid) {
      const container = document.getElementById(`${pid}_sensor_list`);
      if (!container) return;
      const outdoor = JSON.parse(container.dataset.outdoor || '[]').map(s => s.toLowerCase());
      const exclude = JSON.parse(container.dataset.exclude || '[]').map(s => s.toLowerCase());

      container.innerHTML = '<p class="text-xs text-gray-500 italic py-2 text-center">Loadingâ€¦</p>';
      try {
        const resp = await fetch(`/api/property/${pid}/sensors`);
        const data = await resp.json();
        const sensors = data.sensors || [];
        if (!sensors.length) {
          container.innerHTML = '<p class="text-xs text-gray-500 italic py-2 text-center">No sensors found yet â€” run a collection first</p>';
          return;
        }
        // Populate primary sensor dropdown
        const sel = document.getElementById(`${pid}_primary_sensor`);
        if (sel) {
          const cur = sel.dataset.current || '';
          sel.innerHTML = '<option value="">â€” none â€”</option>' +
            sensors.map(s => `<option value="${s}"${s === cur ? ' selected' : ''}>${s}</option>`).join('');
        }

        // Header row
        let html = `<div class="grid grid-cols-[1fr,44px,52px,40px] text-xs text-gray-500 px-1 pb-1 border-b border-gray-600 mb-1">
          <span>Sensor</span>
          <span class="text-center">ğŸ </span>
          <span class="text-center">ğŸŒ²</span>
          <span class="text-center">ğŸš«</span>
        </div>`;
        sensors.forEach((s, i) => {
          const key = s.toLowerCase();
          const isOutdoor = outdoor.includes(key);
          const isExclude = exclude.includes(key);
          const isIndoor  = !isOutdoor && !isExclude;
          const rn = `${pid}_sr_${i}`;
          html += `<div class="grid grid-cols-[1fr,44px,52px,40px] items-center px-1 py-0.5 rounded hover:bg-gray-600" data-sensor="${s.replace(/"/g,'&quot;')}">
            <span class="text-sm text-gray-200 truncate" title="${s.replace(/"/g,'&quot;')}">${s}</span>
            <input type="radio" class="mx-auto accent-blue-500 cursor-pointer" name="${rn}" value="indoor"  ${isIndoor  ? 'checked' : ''}>
            <input type="radio" class="mx-auto accent-green-500 cursor-pointer" name="${rn}" value="outdoor" ${isOutdoor ? 'checked' : ''}>
            <input type="radio" class="mx-auto accent-red-400 cursor-pointer"  name="${rn}" value="exclude" ${isExclude ? 'checked' : ''}>
          </div>`;
        });
        container.innerHTML = html;
      } catch(e) {
        container.innerHTML = `<p class="text-xs text-red-400 py-2 text-center">Error: ${e.message}</p>`;
      }
    }

    // Settings panel toggle
    function toggleSettings() {
      const panel = document.getElementById('settings-panel');
      const btn   = document.getElementById('settings-btn');
      const shown = !panel.classList.contains('hidden');
      panel.classList.toggle('hidden', shown);
      btn.classList.toggle('bg-gray-700', !shown);
      btn.classList.toggle('text-white',  !shown);
      if (!shown) {
        // Load sensor lists for all properties
        {% for card in cards %}loadSensors('{{ card.id }}');
        {% endfor %}
        setTimeout(() => panel.scrollIntoView({ behavior: 'smooth', block: 'start' }), 50);
      }
    }

    async function clearWaterAlert(alertId) {
      try {
        const resp = await fetch(`/api/alerts/${alertId}/clear`, { method: 'POST' });
        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          alert(`Clear failed: ${err.error || resp.status}`);
          return;
        }
        const row = document.getElementById(`alert-row-${alertId}`);
        if (row) row.remove();
        // Keep summary and card counts consistent after clear.
        window.location.reload();
      } catch (e) {
        alert(`Clear failed: ${e.message}`);
      }
    }

    // Save thresholds for a property
    async function saveThresholds(pid) {
      const g = id => document.getElementById(`${pid}_${id}`)?.value?.trim() ?? '';
      const cb = id => !!document.getElementById(`${pid}_${id}`)?.checked;
      const csv = id => g(id).split(',').map(s => s.trim()).filter(Boolean);

      // Collect sensor classifications from radio buttons
      const outdoor = [], exclude = [];
      document.querySelectorAll(`#${pid}_sensor_list [data-sensor]`).forEach(row => {
        const name = row.dataset.sensor;
        const val  = row.querySelector('input[type="radio"]:checked')?.value;
        if (val === 'outdoor') outdoor.push(name);
        if (val === 'exclude') exclude.push(name);
      });

      const primarySensor = document.getElementById(`${pid}_primary_sensor`)?.value || '';
      const payload = {
        indoor_temp_warning:   parseFloat(g('indoor_temp_warning')),
        indoor_temp_critical:  parseFloat(g('indoor_temp_critical')),
        outdoor_temp_warning:  parseFloat(g('outdoor_temp_warning')),
        outdoor_temp_critical: parseFloat(g('outdoor_temp_critical')),
        outdoor_sensors:       outdoor,
        exclude_sensors:       exclude,
        primary_temp_sensor:   primarySensor,
        battery_low_threshold_percent:      parseFloat(g('battery_low_threshold_percent')),
        battery_critical_threshold_percent: parseFloat(g('battery_critical_threshold_percent')),
        battery_cooldown_minutes:           parseFloat(g('battery_cooldown_minutes')),
        battery_pushover_enabled:           cb('battery_pushover_enabled'),
        battery_exclude_devices:            csv('battery_exclude_devices'),
        offline_timeout_minutes:            parseFloat(g('offline_timeout_minutes')),
        offline_cooldown_minutes:           parseFloat(g('offline_cooldown_minutes')),
        offline_pushover_enabled:           cb('offline_pushover_enabled'),
        water_pushover_enabled:             cb('water_pushover_enabled'),
        water_exclude_sensors:              csv('water_exclude_sensors'),
      };

      const statusEl = document.getElementById(`${pid}_status`);
      statusEl.classList.remove('hidden', 'text-green-400', 'text-red-400');
      statusEl.textContent = 'Savingâ€¦';
      statusEl.classList.add('text-gray-400');
      try {
        const resp = await fetch(`/api/config/thresholds/${pid}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload),
        });
        if (resp.ok) {
          statusEl.textContent = 'âœ“ Saved';
          statusEl.classList.replace('text-gray-400', 'text-green-400');
          // Update data-* so re-opening shows updated state
          const container = document.getElementById(`${pid}_sensor_list`);
          if (container) {
            container.dataset.outdoor = JSON.stringify(outdoor);
            container.dataset.exclude = JSON.stringify(exclude);
          }
          const selEl = document.getElementById(`${pid}_primary_sensor`);
          if (selEl) selEl.dataset.current = primarySensor;
        } else {
          const err = await resp.json();
          statusEl.textContent = `âœ— Error: ${err.error || resp.status}`;
          statusEl.classList.replace('text-gray-400', 'text-red-400');
        }
      } catch (e) {
        statusEl.textContent = `âœ— ${e.message}`;
        statusEl.classList.replace('text-gray-400', 'text-red-400');
      }
      setTimeout(() => statusEl.classList.add('hidden'), 4000);
    }
  </script>

</body>
</html>
